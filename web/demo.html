<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Totem WebAssembly Demo</title>
    <style>
      body {
        font-family: "Inter", system-ui, sans-serif;
        background: #f4f6fb;
        color: #1f2933;
        margin: 0;
        padding: 0;
      }

      header {
        background: linear-gradient(120deg, #4f46e5, #9333ea);
        color: white;
        padding: 2.5rem;
        box-shadow: 0 4px 20px rgba(79, 70, 229, 0.35);
      }

      header h1 {
        margin: 0 0 0.5rem;
        font-size: 2.4rem;
        font-weight: 700;
        letter-spacing: 0.03em;
      }

      header p {
        margin: 0;
        font-size: 1.05rem;
        max-width: 60ch;
      }

      main {
        padding: 2rem 3vw 4rem;
        display: grid;
        gap: 2rem;
      }

      section {
        background: white;
        border-radius: 18px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
        padding: 1.75rem;
      }

      h2 {
        margin-top: 0;
        font-size: 1.4rem;
        font-weight: 600;
        color: #312e81;
      }

      code {
        background: rgba(99, 102, 241, 0.12);
        padding: 0.25rem 0.4rem;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      #log {
        font-family: "Fira Code", "SFMono-Regular", Menlo, Consolas, monospace;
        background: #0f172a;
        color: #e0e7ff;
        padding: 1rem;
        border-radius: 12px;
        min-height: 5rem;
        white-space: pre-wrap;
      }

      #viz {
        width: 100%;
        height: 520px;
      }

      .legend {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .legend span {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.9rem;
      }

      .legend .swatch {
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
        display: inline-block;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 1rem;
        border-radius: 12px;
        background: rgba(16, 185, 129, 0.15);
        color: #047857;
        font-weight: 600;
      }

      .status.error {
        background: rgba(239, 68, 68, 0.15);
        color: #b91c1c;
      }

      footer {
        text-align: center;
        padding: 1.5rem 0 2.5rem;
        color: #475569;
        font-size: 0.85rem;
      }

      a {
        color: #4338ca;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
    <script type="module">
      import wabtFactory from "https://unpkg.com/wabt@1.0.33/lib/wabt.js?module";

      const gradeColors = {
        pure: "#8BC34A",
        state: "#FFEB3B",
        io: "#FF7043",
        sys: "#9575CD",
        meta: "#B0BEC5",
      };

      const logEl = document.getElementById("log");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("wasm-result");

      function appendLog(message) {
        logEl.textContent += `${message}\n`;
      }

      function formatScopes(scope, context) {
        const { nodes, links, lifetimeMap } = context;

        for (const node of scope.nodes || []) {
          nodes.push({
            id: node.id,
            label: `${node.op} [${node.grade}]`,
            grade: node.grade || "pure",
          });

          if (node.lifetime_id) {
            lifetimeMap.set(node.lifetime_id, node.id);
          }

          for (const borrow of node.borrows || []) {
            const target = lifetimeMap.get(borrow.target) || borrow.target;
            links.push({
              source: target,
              target: node.id,
              kind: borrow.kind,
            });
          }
        }

        for (const child of scope.children || []) {
          formatScopes(child, context);
        }

        return context;
      }

      async function loadArtifacts() {
        const [watResp, bitcodeResp] = await Promise.all([
          fetch("program.wat"),
          fetch("program.totem.json"),
        ]);

        if (!watResp.ok || !bitcodeResp.ok) {
          throw new Error(
            "Missing artifacts. Build them with `python totem.py --wasm web/program.wat --wasm-metadata web/program.wasm.json` and copy program.totem.json into web/."
          );
        }

        const [watSource, bitcode] = await Promise.all([
          watResp.text(),
          bitcodeResp.json(),
        ]);

        return { watSource, bitcode };
      }

      async function instantiateWasm(watSource) {
        const wabt = await wabtFactory();
        const parsed = wabt.parseWat("program.wat", watSource);
        const { buffer } = parsed.toBinary({ write_debug_names: true });

        const ioLog = [];
        const imports = {
          totem_io: {
            io_read() {
              const value = 7;
              ioLog.push(`io.read → ${value}`);
              return value;
            },
            io_write(value) {
              ioLog.push(`io.write ← ${value}`);
            },
          },
        };

        const { instance } = await WebAssembly.instantiate(buffer, imports);
        const result = instance.exports.run();

        return { result, ioLog };
      }

      function renderViz(bitcode) {
        const context = {
          nodes: [],
          links: [],
          lifetimeMap: new Map(),
        };
        const { nodes, links } = formatScopes(bitcode.root_scope, context);
        const svg = d3.select("#viz");
        svg.selectAll("*").remove();

        const width = svg.node().clientWidth || 800;
        const height = svg.node().clientHeight || 520;

        const simulation = d3
          .forceSimulation(nodes)
          .force("link", d3.forceLink(links).id((d) => d.id).distance(120))
          .force("charge", d3.forceManyBody().strength(-220))
          .force("center", d3.forceCenter(width / 2, height / 2));

        const link = svg
          .append("g")
          .attr("stroke", "#cbd5f5")
          .attr("stroke-width", 1.5)
          .selectAll("line")
          .data(links)
          .join("line");

        const node = svg
          .append("g")
          .attr("stroke", "#1e293b")
          .attr("stroke-width", 1.2)
          .selectAll("circle")
          .data(nodes)
          .join("circle")
          .attr("r", 22)
          .attr("fill", (d) => gradeColors[d.grade] || "#cbd5f5")
          .call(
            d3
              .drag()
              .on("start", (event) => {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
              })
              .on("drag", (event) => {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
              })
              .on("end", (event) => {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
              })
          );

        const labels = svg
          .append("g")
          .attr("font-family", "Fira Code, monospace")
          .attr("font-size", 12)
          .attr("font-weight", 600)
          .attr("fill", "#0f172a")
          .selectAll("text")
          .data(nodes)
          .join("text")
          .text((d) => d.label)
          .attr("text-anchor", "middle")
          .attr("dy", 4);

        simulation.on("tick", () => {
          link
            .attr("x1", (d) => d.source.x)
            .attr("y1", (d) => d.source.y)
            .attr("x2", (d) => d.target.x)
            .attr("y2", (d) => d.target.y);

          node.attr("cx", (d) => d.x).attr("cy", (d) => d.y);
          labels.attr("x", (d) => d.x).attr("y", (d) => d.y + 42);
        });
      }

      async function boot() {
        try {
          statusEl.textContent = "Loading artifacts…";
          const { watSource, bitcode } = await loadArtifacts();

          statusEl.textContent = "Compiling WebAssembly…";
          const { result, ioLog } = await instantiateWasm(watSource);
          resultEl.textContent = result;

          if (ioLog.length) {
            appendLog(ioLog.map((entry) => `• ${entry}`).join("\n"));
          } else {
            appendLog("• (no IO imports invoked)");
          }
          renderViz(bitcode);
          statusEl.textContent = "Ready.";
        } catch (err) {
          statusEl.textContent = "Demo failed";
          statusEl.classList.add("error");
          appendLog(String(err));
          console.error(err);
        }
      }

      boot();
    </script>
  </head>
  <body>
    <header>
      <h1>Totem → WebAssembly</h1>
      <p>
        This demo lowers the pure Totem TIR to WebAssembly, wires IO nodes as
        host imports guarded by capabilities, and reuses the lifetime graph for a
        browser-native visualization.
      </p>
    </header>
    <main>
      <section>
        <h2>Status</h2>
        <div id="status" class="status">Starting…</div>
      </section>
      <section>
        <h2>WebAssembly result</h2>
        <p>
          The exported <code>run()</code> function returns the last pure value in
          the program. IO operations are delegated to capability-gated host
          imports defined in the browser.
        </p>
        <div class="status">Return value: <span id="wasm-result">—</span></div>
        <h3>Capability log</h3>
        <div id="log"></div>
      </section>
      <section>
        <h2>Scope &amp; lifetime visualization</h2>
        <svg id="viz"></svg>
        <div class="legend">
          <span><span class="swatch" style="background:#8BC34A"></span> Pure</span>
          <span><span class="swatch" style="background:#FF7043"></span> IO</span>
          <span><span class="swatch" style="background:#9575CD"></span> Sys</span>
          <span><span class="swatch" style="background:#B0BEC5"></span> Meta</span>
        </div>
      </section>
    </main>
    <footer>
      Serve this directory with <code>python -m http.server</code> and open
      <code>demo.html</code> in your browser.
    </footer>
  </body>
</html>
